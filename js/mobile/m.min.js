/*! 中教启星M版 2015-06-22 */
define("ajax",function(require){var Uri=require("uri"),_requestList=[],equal=function(obj1,obj2){return"string"==typeof obj1&&"string"==typeof obj2?obj1===obj2:"object"==typeof obj1&&"object"==typeof obj2?$.param(obj1)===$.param(obj2):!1},isCrossDomain=function(url){var uri=new Uri(url),host=uri.host();return""!==uri.protocol()&&""!==host&&host!==document.domain},createPostForm=function(settings){var datas,$form=$('<form method="post"></form>').attr({action:settings.url}).appendTo(document.body),data=settings.data||"",dataJSON={};return"string"==typeof data?(datas=data.split("&"),$.each(datas,function(index,item){item=item.split("="),dataJSON[item[0]]=item[1]})):dataJSON=data,$.each(dataJSON,function(key,value){$('<input type="hidden"/>').attr({name:key,value:value}).appendTo($form)}),$form},crossDomainPost=function(settings){var AjaxForm=require("ajaxform"),$form=createPostForm(settings);new AjaxForm($form,{onComplete:function(result){$($form.attr("target")).remove(),$form.remove(),settings.success&&settings.success(result),_.isFunction(settings.complete)?settings.complete(result):_.isArray(settings.complete)&&_.each(settings.complete,function(fun){fun(result)})}}),$form.submit()},beforeSend=function(settings){for(var i=0,len=_requestList.length;len>i;i++){var _request=_requestList[i];if(settings.url==_request.url&&equal(_request.data,settings.data))return!1}_requestList.push(settings);var _type=settings.type.toLowerCase();if(isCrossDomain(settings.url)){if("post"===_type)return crossDomainPost(settings),!1;settings.dataType="jsonp"}return settings};return{ajax:function(options){var complete=[function(){_requestList=_.without(_requestList,options)}],success=[function(data){2==data.result}];options.complete&&(complete=complete.concat(options.complete)),options.complete=void 0,options.success&&(success=success.concat(options.success)),options.success=void 0,options=$.extend({timeout:1e4,jsonp:"callback",type:"get",complete:complete,success:success},options);var checkResult=!0;if(options.beforeSend&&"function"==typeof options.beforeSend&&(checkResult=options.beforeSend()),checkResult!==!1){var settings=beforeSend(options);return settings?$.ajax(settings):void 0}},get:function(url,data,success,dataType){var options={type:"GET"};return url&&(options.url=url),"function"==typeof data?options.success=data:data&&(options.data=data),"function"==typeof success?options.success=success:success&&(options.dataType=success),dataType&&(options.dataType=dataType),this.ajax(options)},getJSON:function(url,data,success){return this.get(url,data,success,"json")},post:function(url,data,success,dataType){var options={type:"POST"};return url&&(options.url=url),"function"==typeof data?options.success=data:data&&(options.data=data),"function"==typeof success?options.success=success:success&&(options.dataType=success),dataType&&(options.dataType=dataType),this.ajax(options)}}}),define("util",function(){var util={timeFormat:function(time){var timeStr,date=new Date(time),curDate=new Date,year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate(),hour=date.getHours(),minute=date.getMinutes(),curYear=curDate.getFullYear(),curHour=curDate.getHours();if(minute=minute>10?minute:"0"+minute,curYear>year)timeStr=year+"年"+month+"月"+day+"日 "+hour+":"+minute;else{var pastTime=curDate-date,pastH=pastTime/36e5;if(pastH>curHour)timeStr=month+"月"+day+"日 "+hour+":"+minute;else if(pastH>=1)timeStr="今天 "+hour+":"+minute;else{var pastM=curDate.getMinutes()-minute;timeStr=pastM>1?pastM+" 分钟前":" 刚刚"}}return timeStr},loadImg:function(src,dataId){if(src){var standardRatio=.75,fixWidth=280,fixHeight=210,preloadImg=new Image,selector='.feed_pic_list li img[data-id="'+dataId+'"]';preloadImg.onload=function(){preloadImg.onload=null;var width=preloadImg.width,height=preloadImg.height,origiRatio=1e3*parseFloat((height/width).toFixed(3)),minRatio=1e3*(standardRatio-.2),maxRatio=1e3*(standardRatio+.2),ratio=1e3*standardRatio;150>width&&150>height?$(selector).attr("width",width).attr("height",height):origiRatio>minRatio&&ratio>origiRatio||origiRatio>1100?$(selector).attr("height",fixHeight):origiRatio>ratio&&maxRatio>origiRatio||400>origiRatio?$(selector).attr("width",fixWidth):$(selector).attr("width",fixWidth)},preloadImg.src=src}}};return util}),define("feedback",function(){var feedbackGroup=function(){var config={wrapper:window,callBack:null},getScrollOffsets=function(w){if(w=w||window,null!=w.pageXOffset)return{x:w.pageXOffset,y:w.pageYOffset};var d=w.document;return"CSS1Compat"==document.compatMode?{x:d.documentElement.scrollLeft,y:d.documentElement.scrollTop}:{x:d.body.scrollLeft,y:d.body.scrollTop}},getViewportSize=function(w){if(w=w||window,null!=w.innerWidth)return{w:w.innerWidth,h:w.innerHeight};var d=w.document;return"CSS1Compat"==document.compatMode?{w:d.documentElement.clientWidth,h:d.documentElement.clientHeight}:{w:d.body.clientWidth,h:body.clientHeight}},initEvent=function(){var backTop=$(".gotoTop"),viewSize=getViewportSize(),timer=null,istop=!0;backTop.on("click",function(event){{var evt=event||window.Event;evt.target||evt.srcElement,getScrollOffsets()}window.event?evt.cancelBubble=!0:evt.stopPropagation(),timer=setInterval(function(){var top=document.documentElement.scrollTop||document.body.scrollTop,ispeed=(viewSize.h,Math.floor(-top/6));document.documentElement.scrollTop=document.body.scrollTop=top+ispeed,0===top&&clearInterval(timer),istop=!0},30)}),window.onscroll=function(){var itop=document.documentElement.scrollTop||document.body.scrollTop,clientHeight=viewSize.h;backTop.css(itop>=clientHeight?{display:"block"}:{display:"none"}),istop||clearInterval(timer),istop=!1}};return{init:function(cfg){_.extend(config,cfg),initEvent()}}};return feedbackGroup()}),define("tipbox",function(){var tipBox=function(){var config={width:180,height:150,str:"正在处理",windowDom:window,setTime:0,hasMask:!1,hasMaskWhite:!1,clickDomCancel:!0,callBack:null,type:"success"},_mask=null,boundingBox=null,renderUI=function(tipType){boundingBox=$("<div id='animationTipBox'></div>"),"load"==tipType&&loadRenderUI(),"tip"==tipType&&tipRenderUI(),boundingBox.appendTo(config.windowDom.document.body),config.hasMask&&(_mask=$(config.hasMaskWhite?"<div class='mask_white'></div>":"<div class='mask'></div>"),_mask.appendTo(config.windowDom.document.body)),_this=this,!config.setTime&&"function"==typeof config.callBack&&(config.setTime=1),config.setTime&&setTimeout(function(){close()},config.setTime)},bindUI=function(){_this=this,config.clickDomCancel&&boundingBox&&boundingBox.click(function(){close()})},syncUI=function(){boundingBox.css({width:config.width+"px",height:config.height+"px",marginLeft:"-"+config.width/2+"px",marginTop:"-"+config.height/2+"px"})},close=function(){destroy(),config.setTime&&"function"==typeof config.callBack&&config.callBack()},destroy=function(){_mask&&_mask.remove(),boundingBox&&boundingBox.remove(),boundingBox=null},tipRenderUI=function(){var tip="<div class='tip'>";tip+="		<div class='icon'>i</div>",tip+="		<div class='dec_txt'>"+config.str+"</div>",tip+="</div>",boundingBox.append(tip)},loadRenderUI=function(){var load="<div class='load'>";load+="<div class='icon_box'>";for(var i=1;4>i;i++)load+="<div class='cirBox"+i+"'>",load+="<div class='cir1'></div>",load+="<div class='cir2'></div>",load+="<div class='cir3'></div>",load+="<div class='cir4'></div>",load+="</div>";load+="</div>",load+="</div>",load+="<div class='dec_txt'>"+config.str+"</div>",boundingBox.append(load)},init=function(cfg){$.extend(config,cfg)},render=function(el){var tipType=config.type;renderUI(tipType),bindUI(),syncUI(),$(el||config.windowDom.document.body).append(boundingBox)};return{show:function(cfg,el){init(cfg),render(el)},close:function(){close()}}};return tipBox()}),define("config",function($config){return _.extend({INDEX:{GET_MOVIES:"https://api.douban.com/v2/movie/search",GET_MOVIEINFO:"https://api.douban.com/v2/movie/subject/",GET_REVIEWS:"https://api.douban.com/v2/movie/subject/:id/reviews",GET_PHOTOS:"https://api.douban.com/v2/movie/subject/:id/photos",GET_BOOKS:"https://api.douban.com/v2/book/search",GET_BOOKINFO:"https://api.douban.com/v2/book/"}},$config)}),define("template",["config"],function(){return{INDEX_HEAD_TPL:['<div class="top_user_info">','<a href="#index/space/{{data.userId}}">','<img src="{{data.userId}}.jpg" />','<span class="user_name">{{data.userName}}</span>',"</a></div>",'<a href="javascript:;" class="publish_btn"><span class="icon-edit"></span></a>'].join(),INDEX_MOVIE_TPL:["{@each list as item}",'<div class="feed_box">',"{# 基本信息}",'<header class="feed_header clearfix">',"{@if item.rating }",'<span class="fr star"><span class="star50"></span>{{item.rating.average}}</span>',"{@/if}",'<dl class="user_info">','<dd class="user_related">','<a href="#{{viewName}}/{{item.id}}" class="user_name cont_title ">{{item.title}}</a>',"{# 类型}",'<p class="meta color8">',"{@each item.genres as genre}",'<span class="">{{genre}}</span>',"{@/each}","</p>","{# 导演 主演}",'<p class="meta color8">',"{@each item.actors as actor}",'<a href="javascript:;" class="">{{actor}}</a>',"{@/each}","</p>","</dd></dl></header>",'<a href="#{{viewName}}/{{item.id}}">',"{# 内容}",'<section class="feed_cont">',"{# 图片列表}",'<div class="feed_pic"><ul class="feed_pic_list" data-imgs="{{item.imgs}}">',"{@each item.imgs as img, index}","{@if index < 4 }",'<li><span class="pic_wrap">','<img src="{{img}}"/>','<i class="valign"></i></span></li>',"{@/if}","{@/each}","</ul></div>","</section>","</a>","{# 赞、评论}",'<footer class="gray_bar flex_equal">','<a href="javascript:;" class="flex_item"><i class="iconfont icon-heart"></i><span class="color8 text_sub">{{item.collect_count}}</span></a>','<span class="line_gradient"></span>','<a href="javascript:;" class="flex_item"><i class="iconfont icon-star"></i><span class="color8 text_sub">{{item.rating.stars}}</span></a>',"</footer>","</div>","{@/each}"].join(""),INFO_MOVIE_TPL:['<nav class="top_navgination clearfix">','<a href="javascript:;" class="fl back J_movie_back"><i class="arror_left"></i></a>','<h1 class="top_title txt_cut">电影介绍</h1>',"</nav>","{# 具体内容}",'<div class="artical_cont mb60">',"{# 标题区}",'<header class="info_title information_title clearfix">','<h2><a href="{{data.mobile_url}}">{{data.title}}</a></h2>','<span class="fr star"><span class="star50"></span>{{data.rating.average}}</span>',"</header>","{# 剧情}",'<article class="info_detail">{{{data.summary}}}',"{# 剧照}","{@if data.images }",'<ul class="talk_imgs">','<li><img src="{{data.images["large"]}}" /></li>',"{@each data.imgs as img}",'<li><img src="{{img}}" /></li>',"{@/each}","</ul>","{@/if}","</article>","{# 数据统计 }",'<section class="gray_bar cont_footer clearfix">','<div class="fl count_num">评论 {{data.comments_count}}</div>','<div class="fr flex_equal bar_opt">','<a href="#" class="flex_item"><i class="iconfont icon-heart"></i><span class="color8">{{data.reviews_count}}</span></a>','<span class="line_gradient"></span>','<a href="#" class="flex_item"><i class="iconfont icon-reproduce"></i><span class="color8">{{data.wish_count}}</span></a>','<span class="line_gradient"></span>','<a href="#" class="flex_item"><i class="iconfont icon-star"></i><span class="color8">{{data.ratings_count}}</span></a>',"</div>","</section>","{# 导演 演员 展示区}",'<section class="message_wrap J_actors"></section>',"{# 评论列表区}",'<section class="comment_list J_movie_comments">',"</section>","</div>"].join(""),MOVIE_ACTOR_TPL:["{@each list as data}",'<div class="avatar_box msg_item clearfix">','<div class="fl avatar">','<div class="color_block blue_bg pink_bg">','{@if data.avatars["small"] }','<a href="{{data.alt}}"><img src="{{data.avatars["small"]}}"/></a>',"{@/if}","</div>","</div>",'<div class="content">','<div class="msg_info clearfix">{{data.role}}<span class="fr gray_txt"></span></div>','<div class="msg_type title_txt">{{data.name}}</div>',"</div>","</div>","{@/each}"].join(""),INFO_COMMENTS_TPL:["{@each list as it}",'<div class="comment_item">','<header class="avatar_box clearfix">','<div class="fl avatar">','<a href="#">','<img src="{{it.comment.userId}}.jpg" onerror="javascript:this.src=\'/images/app/honeybee/demoimg/default1.gif\'"/>',"</a>","</div>",'<div class="content">','<div class="related_info">','<a href="#" class="fr gray_txt">回复</a>','<span class="title_txt">{{it.comment.userName}}</span>',"</div>",'<span class="gray_txt">{{it.comment.createDate}}</span>',"</div>","</header>",'<article class="coment_cont">{{it.comment.content}}</article>',"</div>","{@/each}"].join(""),INFO_PICS_TPL:['<nav class="top_navgination info_pics_header clearfix">','<a href="javascript:;" class="fl back J_info_back"><i class="arror_left"></i></a>','<a href="javascript:;" class="fr publish J_pic_comments">{{data.commentCount}}条评论</a>','<h1 class="top_title txt_cut J_pics_title">图片浏览</h1>',"</nav>","{# 图片浏览区 }",'<section class="info_pics J_pics_wrapper"></section>','<footer class="info_pics_footer">','<div class="info_pics_summary J_pic_summary"></div>',"{# 统计数据 }",'<div class="gray_bar info_pics_stistic flex_equal J_pic_footer">','<a href="javascript:;" class="flex_item"><i class="iconfont icon-heart"></i><span class="color8">{{data.diggCount}}</span></a>','<span class="line_gradient"></span>','<a href="javascript:;" class="flex_item"><i class="iconfont icon-reproduce"></i><span class="color8">{{data.transferCount}}</span></a>','<span class="line_gradient"></span>','<a href="javascript:;" class="flex_item"><i class="iconfont icon-star"></i><span class="color8">{{data.collectCount}}</span></a>',"</div></footer>"].join(""),INFO_PICS_FOOTER_TPL:["{# 统计数据 }",'<a href="javascript:;" class="flex_item"><i class="iconfont icon-heart"></i><span class="color8">{{data.diggCount}}</span></a>','<span class="line_gradient"></span>','<a href="javascript:;" class="flex_item"><i class="iconfont icon-reproduce"></i><span class="color8">{{data.transferCount}}</span></a>','<span class="line_gradient"></span>','<a href="javascript:;" class="flex_item"><i class="iconfont icon-star"></i><span class="color8">{{data.collectCount}}</span></a>'].join(""),BOOKS_TPL:['<li class="book_box">','<a href="#books/{{data.id}}">','<span class="pic_wrap">','<img src="{{data.images["large"]}}"/>','<i class="valign"></i></span>','<p class="title">{{data.title}}</p>',"</a>","</li>"].join(""),INFO_BOOK_TPL:['<nav class="top_navgination clearfix">','<a href="javascript:;" class="fl back J_book_back"><i class="arror_left"></i></a>','<h1 class="top_title txt_cut">图书介绍</h1>',"</nav>","{# 具体内容}",'<div class="artical_cont mb60">',"{# 标题区}",'<header class="info_title information_title clearfix">','<h2><a href="{{data.alt}}">{{data.title}}</a></h2>','<span class="fr star"><span class="star50"></span>{{data.rating.average}}</span>',"</header>","{# 剧情}",'<article class="info_detail">{{{data.summary}}}',"{# 剧照}","{@if data.images }",'<ul class="talk_imgs">','<li><img src="{{data.images["large"]}}" /></li>',"</ul>","{@/if}","</article>","{# 目录结构 }",'<article class="info_detail">{{data.catalog}}</article>',"{# 作者}",'<article class="info_detail">{{data.author_intro}}</article>',"</div>"].join("")}}),define("router",["index","movieInfo","bookInfo"],function(app,MovieInfo,BookInfo){var AppRouter=Backbone.Router.extend({options:{movieInfo:null,bookInfo:null,index:$(".J_index"),info:$(".J_info")},initialize:function(){},routes:{"movies/:id":"showMovieInfo","space/:type/:feedId":"showSpaceFeed","books/:id":"showBookInfo"},switchPage:function(inPage,outPage){outPage.addClass("old_page out"),inPage.addClass("show in"),setTimeout(function(){outPage.removeClass("old_page out").hide(),inPage.removeClass("show in").addClass("current"),inPage.get(0).scrollIntoView()},400)},showMovieInfo:function(id){var _this=this;if(id){this.options.movieInfo||(this.options.movieInfo=new MovieInfo);var infoView=this.options.movieInfo,callback=function(){var index=_this.options.index,info=_this.options.info;_this.switchPage(info,index)};infoView.getMovie(id,callback)}},showBookInfo:function(id){var _this=this;if(id){this.options.bookInfo||(this.options.bookInfo=new BookInfo);var infoView=this.options.bookInfo,callback=function(){var index=_this.options.index,info=_this.options.info;_this.switchPage(info,index)};infoView.getBook(id,callback)}}});return AppRouter}),define("picUtil",["config","juicer","template","ajax","util"],function($config,juicer,tpl,Ajax){var picUtil={picType:2,containerId:"",containerType:"",getPic:function(feedId,callback){var _this=this,picInfo=feedId.split("-"),picType=_this.picType=picInfo[0],phtotoId=picInfo[picInfo.length-1],cb=function(info){$(".J_info").html(juicer(tpl.INFO_PICS_TPL,{data:info}));var picTypeId=info.picTypeId;_this.getPicGroup(picTypeId,1,phtotoId),callback&&callback(info)};if(picType)switch(picType){case"1":case"3":Ajax.get($config.INDEX.GET_INFO_PIC,{photoId:phtotoId},function(json){if(1===json.result){var data=json.data,baseData=data.sphoto,statistics=data.semantideStatistics,info={picTypeId:baseData.selfTypeId,summary:baseData.summary||"",photoUrl:baseData.photoUrl,photoId:baseData.photoId,collectCount:statistics.collectCount>0?statistics.collectCount:"收藏",commentCount:statistics.commentCount>0?statistics.commentCount:"0",diggCount:statistics.diggCount>0?statistics.diggCount:"赞",transferCount:statistics.transferCount>0?statistics.transferCount:"转发"};cb(info)}});break;case"2":var containerId=_this.containerId=picInfo[1],containerType=_this.containerType=picInfo[2],containerPhotoId=_this.containerPhotoId=picInfo[3];Ajax.get($config.INDEX.GET_INFO_CONPIC,{containerPhotoId:containerPhotoId,containerType:containerType,containerId:containerId},function(json){if(1===json.result){var data=json.data,baseData=data.sContainerPhoto,statistics=data.sSemantideStatistics,info={picTypeId:baseData.containerContentCategoryId,summary:baseData.photoSummary||"",photoUrl:baseData.photoUrl,photoId:baseData.photoId,collectCount:statistics.collectCount>0?statistics.collectCount:"收藏",commentCount:statistics.commentCount>0?statistics.commentCount:"0",diggCount:statistics.diggCount>0?statistics.diggCount:"赞",transferCount:statistics.transferCount>0?statistics.transferCount:"转发"};cb(info)}})}},getPics:function(picTypeId,pageNo,callback,photoId){var _this=this,pageSize=10,picType=_this.picType,containerType=_this.containerType,cb=function(data,totalCount){var list=data,index=0,find=1==pageNo?!1:!0,data=_.map(list,function(item){var phId=item.containerPhotoId||item.photoId;find||(index++,photoId==phId&&(find=!0));var userId=item.originalUserId&&"0"!==item.originalUserId?item.originalUserId:item.userId||item.userId;return{photoId:item.photoId,cPhotoId:phId,summary:item.photoSummary,content:"/uploads/honeybee/data/upload/photo/"+userId+"/"+item.photoUrl}});"function"==typeof callback&&callback(data,totalCount,index)};if(picType)switch(picType){case"3":case"1":Ajax.get($config.INDEX.GET_INFO_PICGROUP,{selfTypeId:picTypeId,pageNo:pageNo,pageSize:pageSize},function(json){if(1===json.result){var totalCount=json.data.totalCount,data=json.data.data;"function"==typeof cb&&cb(data,totalCount)}});break;case"2":var containerId=_this.containerId,containerType=_this.containerType;Ajax.get($config.INDEX.GET_INFO_CONPICGROUP,{containerId:containerId,containerType:containerType,containerContentCategoryId:picTypeId,pageNo:pageNo,pageSize:pageSize},function(json){if(1===json.result){var totalCount=json.data.totalCount,data=json.data.data;"function"==typeof cb&&cb(data,totalCount)}})}},getPicGroup:function(picTypeId,pageNo,photoId){var _this=this,callback=function(data,totalCount,index){$(".J_pics_title").html(index+" / "+totalCount);new iSlider({type:"pic",data:data,dom:$(".J_pics_wrapper").get(0),animateType:"default",initIndex:index-1,totalCount:totalCount,selfTypeId:picTypeId,onslideend:_this.swipePicFn})};_this.getPics(picTypeId,1,callback,photoId)},getPicInfo:function(photoId,containerPhotoId,containerType){Ajax.get($config.INDEX.GET_INFO_PIC_STATISTICS,{photoId:photoId,containerPhotoId:containerPhotoId,containerType:containerType},function(json){if(1===json.result){var data=json.data,info={},statistics=data.semantideStatistics;info.collectCount=statistics.collectCount>0?statistics.collectCount:"收藏",info.commentCount=statistics.commentCount>0?statistics.commentCount:"0",info.diggCount=statistics.diggCount>0?statistics.diggCount:"赞",info.transferCount=statistics.transferCount>0?statistics.transferCount:"转发",$(".J_pic_footer").html(juicer(tpl.INFO_PICS_FOOTER_TPL,{data:info})),$(".J_pic_comments").html(info.commentCount+"条评论")}})},swipePicFn:function(){var _this=this,pageSize=10,index=_this.slideIndex+1,totalCount=_this._opts&&_this._opts.totalCount||_this.data.length,length=_this.data.length;if(length-2===index&&index%pageSize===8){var pageNo=Math.floor(index/pageSize)+2,selfTypeId=_this._opts.selfTypeId,callback=function(data){$tipbox.close(),$.each(data,function(index,item){_this.data.push(item)}),$(".J_pics_title").html(index+" / "+totalCount)};$tipbox.show({type:"load",str:"努力加载中.."});var me=$Index.config.infoView.config.picUtil;me.getPics(selfTypeId,pageNo,callback)}else $(".J_pics_title").html(index+" / "+totalCount);var item=_this.data[_this.slideIndex],me=$Index.config.infoView.config.picUtil,containerType=me.containerType;$(".J_pic_summary").html(item.summary||""),item.photoId&&me.getPicInfo(item.photoId,item.cPhotoId,containerType)}};return picUtil}),define("movieInfo",["config","juicer","template","ajax","util","picUtil"],function($config,juicer,tpl,Ajax,util,picUtil){var MovieInfo=Backbone.View.extend({el:$(".J_info"),events:{"click .J_movie_commons_more":"","click .J_movie_back":"backTo"},options:{pageNo:1,pageSzie:10,infoType:"",feedId:"",picUtil:picUtil,prevEl:$(".J_index"),current:""},initialize:function(){var infoContent=this.el;infoContent.addEventListener("touchstart",this,!1)},getMovie:function(id,callback){{var _this=this;_this.options.pageSzie||10}this.options.id=id;var url=$config.INDEX.GET_MOVIEINFO+id;Ajax.get(url,function(json){var data=json;$(".J_info").html(juicer(tpl.INFO_MOVIE_TPL,{data:data}));var actors=[];_.each(data.directors,function(director){director.role="导演",director.name&&actors.push(director)}),_.each(data.casts,function(cast){cast.role="演员",cast.name&&actors.push(cast)}),$(".J_actors").html(juicer(tpl.MOVIE_ACTOR_TPL,{list:actors})),"function"==typeof callback&&callback({})})},getComments:function(topicId,pageNo,pageSzie,callback){pageNo=pageNo||this.options.pageNo,pageSize=pageSzie||this.options.pageSize;var start=pageNo*pageSize,url=$config.INDEX.GET_REVIEWS.replace(":id",id);Ajax.get(url,{start:start,count:pageSize},function(json){if(1===json.result){var data=json;$.each(data,function(){}),$(".J_info_comments").html(juicer(tpl.INFO_COMMENTS_TPL,{list:data})),callback&&callback({})}})},getMoreComments:function(){var _this=this,type=_this.options.infoType,feedId=_this.options.feedId,pageNo=++_this.options.pageNo,pageSize=_this.options.pageSzie;_this.getInfoComments(feedId,type,pageNo,pageSize)},handleEvent:function(event){var _this=this;"touchstart"==event.type?_this.start(event):"touchmove"==event.type?_this.move(event):"touchend"==event.type&&_this.end(event)},start:function(event){if(event.touches&&!(event.touches.length<1)){this.isMoving=!0,this.sWidth=$(document.body).width(),this.startTime=(new Date).getTime(),this.startX=event.touches[0].pageX||event.targetTouches[0].pageX,this.startY=event.touches[0].pageY||event.targetTouches[0].pageY,this.supportAnimations=vendor;var infoContent=this.el;infoContent.addEventListener("touchmove",this,!1),infoContent.addEventListener("touchend",this,!1)}},move:function(event){if(event.touches&&!(event.touches.length<1)&&this.isMoving&&this.supportAnimations!==!1){var offset={X:event.targetTouches[0].pageX-this.startX,Y:event.targetTouches[0].pageY-this.startY};if(Math.abs(offset.X)-Math.abs(offset.Y)>10&&offset.X>0){event.preventDefault();var sWidth=this.sWidth,info=this.el,prevEl=this.options.prevEl,prev=prevEl.get(0);prevEl.show().addClass("prev show");var transitionName=css3TransNames.transition,transformName=css3TransNames.transform;info.style[transitionName]="all 0s",prev.style[transitionName]="all 0s",info.style[transformName]="translateX("+offset.X+"px)",prev.style[transformName]="translateX("+(offset.X-sWidth+10)+"px)"}this.offset=offset}},end:function(event){if(event.touches){var _this=this;this.isMoving=!1;var offset=this.offset,boundary=50,absOffset=Math.abs(offset.X),absReverseOffset=Math.abs(offset.Y),info=_this.el,prevEl=_this.options.prevEl,prev=prevEl.get(0),transitionName=css3TransNames.transition,transformName=css3TransNames.transform;this.supportAnimations!==!1&&offset.X>=boundary&&absOffset>absReverseOffset?(info.style[transitionName]="all 0.2s",prev.style[transitionName]="all 0.2s",info.style[transformName]="translateX(100%)",prev.style[transformName]="translateX(0)",setTimeout(function(){_this.$el.removeClass("current"),prevEl.show().removeClass("hide prev show"),info.style[transitionName]="",info.style[transformName]="",prev.style[transitionName]="",prev.style[transformName]="",$appRouter.navigate("",{trigger:!1,replace:!0}),$("video").trigger("pause"),_this.$el.html("")},200)):(prevEl.removeClass("prev show").hide(),info.style[transitionName]="",info.style[transformName]="",prev.style[transitionName]="",prev.style[transformName]=""),this.offset.X=this.offset.Y=0;var infoContent=info;infoContent.removeEventListener("touchmove",this,!1),infoContent.removeEventListener("touchend",this,!1)}},backTo:function(evt){evt.stopPropagation(),evt.preventDefault();var _this=this,info=(_this.options.current,$(".J_info")||_this.$el),prev=$(".J_index")||_this.options.prevEl;$appRouter.navigate("",{trigger:!1,replace:!0}),info.addClass("show out"),prev.show().addClass("old_page in"),setTimeout(function(){info.html(""),info.removeClass("current show out"),prev.removeClass("old_page in").show()},600)}});return MovieInfo}),define("movies",["config","juicer","template","ajax","util","movieInfo"],function($config,juicer,tpl,Ajax){var Movies=Backbone.View.extend({el:$(".J_movies_area"),options:{pageNo:0,pageSize:10,tag:"经典",query:""},events:{"click .J_movies_more":"getMore"},initialize:function(options){_.extend(this.options,options);var callback=function(){};this.getMovies(this.options.pageNo,callback);var movies=this.el;movies.addEventListener("touchstart",this,!1)},getMovies:function(pageNo,callback){var _this=this;pageNo=pageNo||this.options.pageNo;var pageSize=this.options.pageSize||10,start=pageNo*pageSize,q=this.options.query,tag=this.options.tag||"经典";Ajax.get($config.INDEX.GET_MOVIES,{q:q,tag:tag,start:start,count:pageSize},function(json){if(json.count){var data=json.subjects;_this.formatData(data),0===pageNo?(_this.render(data),_this.options.pageNo=pageNo):_this.append(data),"function"==typeof callback&&callback()}})},formatData:function(data){_.each(data,function(obj){var imgs=[],actors=[];obj.images&&obj.images.large&&imgs.push(obj.images.large),obj.directors&&obj.directors.length>0&&_.each(obj.directors,function(director){director.name&&actors.push(director.name),director.avatars&&imgs.push(director.avatars.large)}),obj.casts&&obj.casts.length>0&&_.each(obj.casts,function(cast){cast.name&&actors.push(cast.name),cast.avatars&&imgs.push(cast.avatars.large)}),obj.actors=actors,obj.imgs=imgs})},render:function(data){$(".J_movies").html(juicer(tpl.INDEX_MOVIE_TPL,{list:data,viewName:"movies"}))},append:function(data){$(".J_movies").append(juicer(tpl.INDEX_MOVIE_TPL,{list:data,viewName:"movies"}))},itemTap:function(){},getMore:function(e){e.stopPropagation(),e.preventDefault();var _this=this,pageNo=++_this.options.pageNo,callback=function(){_this.isLoading=!1,$tipbox.close()};"undefined"==typeof _this.isLoading&&(_this.isLoading=!1),_this.isLoading===!1&&(_this.isLoading=!0,$tipbox.show({type:"load",str:"努力加载中.."}),_this.getMovies(pageNo,callback))},handleEvent:function(event){var _this=this;"touchstart"==event.type?_this.start(event):"touchmove"==event.type?_this.move(event):"touchend"==event.type&&_this.end(event)},start:function(event){if(event.touches&&!(event.touches.length<1)){this.isMoving=!0,this.startTime=(new Date).getTime(),this.startX=event.touches[0].pageX,this.startY=event.touches[0].pageY;var movies=this.el;movies.addEventListener("touchmove",this,!1),movies.addEventListener("touchend",this,!1)}},move:function(event){if(event.touches&&!(event.touches.length<1)&&this.isMoving){var offset={X:event.touches[0].pageX-this.startX,Y:event.touches[0].pageY-this.startY};this.offset=offset}},end:function(event){if(event.touches){this.isMoving=!1;{var offset=this.offset;(new Date).getTime()}if(!offset)return this;var xOffset=offset&&Math.abs(offset.X)||0;if(!this.isLoading&&offset.Y<0&&Math.abs(offset.Y+xOffset)>10){var wrapper=this.$el.get(0);wrapper.scrollHeight-wrapper.clientHeight-wrapper.scrollTop<350&&this.getMore(event)}this.offset.X=this.offset.Y=0;var movies=this.el;movies.removeEventListener("touchmove",this,!1),movies.removeEventListener("touchend",this,!1)}}});return Movies}),define("onlines",["config","juicer","template","ajax"],function($config,juicer,tpl,Ajax){var Onlines=Backbone.View.extend({config:{pageNo:1,userId:"",totalPageCount:0,unreadMsgs:null,infoView:null},events:{"click .J_msgs_more":"getMore"},initialize:function(options){_.extend(this.options,options),this.config.pageNo=1,this.getMsgsUnReadCount(),this.getMsgs(this.config.pageNo)},getMsgsUnReadCount:function(){var _this=this,unreadMsgs=_this.config.unreadMsgs=$Index.config.unreadMsgs;if(unreadMsgs){var unread=unreadMsgs.sysMessageCount,content=0===unread?"系统消息":unread+"条系统消息",sys={unread:unread,iconType:"icon-setting",url:"sys",iconbg:"green_bg",content:content};unread=unreadMsgs.appMessageUnRead,content=0===unread?"应用消息":unread+"条应用消息";var apply={unread:unread,iconType:"icon-apps",url:"apply",iconbg:"blue_bg",content:content};unread=unreadMsgs.newCommentCount,content=0===unread?"评论":unread+"条评论消息";var comment={unread:unread,iconType:"icon-talk",url:"comment",iconbg:"orange_bg",content:content};unread=unreadMsgs.newFollowedCount,content=0===unread?"粉丝列表":unread+"个新粉丝关注";var follow={unread:unread,iconType:"icon-people",url:"follow",iconbg:"pink_bg",content:content};$(".J_msgs_comment").html(juicer(tpl.MESSAGES_TYPE_TPL,{data:comment})),$(".J_msgs_follow").html(juicer(tpl.MESSAGES_TYPE_TPL,{data:follow})),$(".J_msgs_sys").html(juicer(tpl.MESSAGES_TYPE_TPL,{data:sys})),$(".J_msgs_apply").html(juicer(tpl.MESSAGES_TYPE_TPL,{data:apply})),_this.config.infoView||(_this.config.infoView=new Info({el:$(".J_info")}))}},resetUnReadCount:function(){var _this=this;Ajax.get($config.INDEX.GET_INDEX_MSGS_UNREAD,{},function(json){if(1===json.result){var data=$Index.config.unreadMsgs=json.data,unread=data.totalCount;0===unread?$(".J_unreads").html(""):$(".J_unreads").addClass("msg_number").html(unread),_this.getMsgsUnReadCount()}})},getMsgs:function(pageNo){var _this=this,pageSize=10;return _this.totalPageCount&&_this.totalPageCount<pageNo?_this:void Ajax.get($config.INDEX.GET_INDEX_MSGS_LINKMEN,{pageNo:pageNo,pageSize:pageSize},function(json){if(1===json.result){var data=json.data&&json.data.pageInfo.data;_this.totalPageCount=json.data.pageInfo.totalPageCount,_this.userId=json.data.userId,_this.formatData(data),_this.append(data)}})},formatData:function(data){var _this=this,friendId="",friendName="";$.each(data,function(index,obj){if(obj.message){var message=obj.message;_this.userId==message.senderId?(friendId=message.reciverId,friendName=message.reciverName):(friendId=message.senderId,friendName=message.senderName),obj.message.senderId=friendId,obj.message.senderName=friendName,obj.message.sendTime=util.timeFormat(parseInt(obj.message.sendTime,10))}})},render:function(data){$(".J_msgs").html(juicer(tpl.MESSAGES_TPL,{list:data}))},append:function(data){$(".J_msgs").append(juicer(tpl.MESSAGES_TPL,{list:data}))},getMore:function(){var me=$Index.config.msgsView,pageNo=++me.config.pageNo;me.getMsgs(pageNo)},getMsgList:function(type,friendId){var _this=this,callback=function(){_this.resetUnReadCount(),$(".J_msgs_"+type).addClass("visited")
};_this.config.infoView&&_this.config.infoView.getMsgList(type,callback,friendId)}});return Onlines}),define("books",["config","juicer","template","ajax"],function($config,juicer,tpl,Ajax){var Books=Backbone.View.extend({el:$(".J_books_area"),options:{pageNo:0,pageSize:4,tag:"经典",query:""},events:{"click .J_books_more":"getMore"},initialize:function(options){_.extend(this.options,options);var Books=this.el;Books.addEventListener("touchstart",this,!1)},getBooks:function(pageNo,callback){var _this=this;pageNo=pageNo||this.options.pageNo;var pageSize=this.options.pageSize||10,start=pageNo*pageSize,q=this.options.query,tag=this.options.tag||"经典";Ajax.get($config.INDEX.GET_BOOKS,{q:q,tag:tag,start:start,count:pageSize},function(json){if(json){var data=json.books;_this.render(data),_this.options.pageNo=pageNo}"function"==typeof callback&&callback()})},render:function(data){for(var uls=$(".J_books ul"),sFragmentHtml="",i=0,len=data.length;len>i;i++){var item=data[i];sFragmentHtml=juicer(tpl.BOOKS_TPL,{data:item}),uls.sort(function(ul1,ul2){return ul1.offsetHeight-ul2.offsetHeight}),uls.first().append(sFragmentHtml)}},getMore:function(e){e.stopPropagation(),e.preventDefault();var _this=this,pageNo=++_this.options.pageNo,callback=function(){_this.isLoading=!1,$tipbox.close()};"undefined"==typeof _this.isLoading&&(_this.isLoading=!1),_this.isLoading===!1&&(_this.isLoading=!0,$tipbox.show({type:"load",str:"努力加载中.."}),_this.getBooks(pageNo,callback))},handleEvent:function(event){var _this=this;"touchstart"==event.type?_this.start(event):"touchmove"==event.type?_this.move(event):"touchend"==event.type&&_this.end(event)},start:function(event){if(event.touches&&!(event.touches.length<1)){this.isMoving=!0,this.startTime=(new Date).getTime(),this.startX=event.touches[0].pageX,this.startY=event.touches[0].pageY;var Books=this.el;Books.addEventListener("touchmove",this,!1),Books.addEventListener("touchend",this,!1)}},move:function(event){if(event.touches&&!(event.touches.length<1)&&this.isMoving){var offset={X:event.touches[0].pageX-this.startX,Y:event.touches[0].pageY-this.startY};this.offset=offset}},end:function(event){if(event.touches){this.isMoving=!1;{var offset=this.offset;(new Date).getTime()}if(!offset)return this;var xOffset=Math.abs(offset.X)||0;if(!this.isLoading&&offset.Y<0&&Math.abs(offset.Y+xOffset)>10){var wrapper=this.el;wrapper.scrollHeight-wrapper.clientHeight-wrapper.scrollTop<350&&this.getMore(event)}this.offset.X=this.offset.Y=0;var Books=this.el;Books.removeEventListener("touchmove",this,!1),Books.removeEventListener("touchend",this,!1)}}});return Books}),define("bookInfo",["config","juicer","template","ajax"],function($config,juicer,tpl,Ajax){var BookInfo=Backbone.View.extend({el:$(".J_info"),events:{"click .J_book_back":"backTo"},options:{pageNo:1,pageSzie:10,prevEl:$(".J_index"),current:""},initialize:function(){var infoContent=this.el;infoContent.addEventListener("touchstart",this,!1)},getBook:function(id,callback){{var _this=this;_this.options.pageSzie||10}this.options.id=id;var url=$config.INDEX.GET_BOOKINFO+id;Ajax.get(url,function(json){var data=json;$(".J_info").html(juicer(tpl.INFO_BOOK_TPL,{data:data}));var actors=[];_.each(data.directors,function(director){director.role="导演",director.name&&actors.push(director)}),"function"==typeof callback&&callback({})})},handleEvent:function(event){var _this=this;"touchstart"==event.type?_this.start(event):"touchmove"==event.type?_this.move(event):"touchend"==event.type&&_this.end(event)},start:function(event){if(event.touches&&!(event.touches.length<1)){this.isMoving=!0,this.sWidth=$(document.body).width(),this.startTime=(new Date).getTime(),this.startX=event.touches[0].pageX||event.targetTouches[0].pageX,this.startY=event.touches[0].pageY||event.targetTouches[0].pageY,this.supportAnimations=vendor;var infoContent=this.el;infoContent.addEventListener("touchmove",this,!1),infoContent.addEventListener("touchend",this,!1)}},move:function(event){if(event.touches&&!(event.touches.length<1)&&this.isMoving&&this.supportAnimations!==!1){var offset={X:event.targetTouches[0].pageX-this.startX,Y:event.targetTouches[0].pageY-this.startY};if(Math.abs(offset.X)-Math.abs(offset.Y)>10&&offset.X>0){event.preventDefault();var sWidth=this.sWidth,info=this.el,prevEl=this.options.prevEl,prev=prevEl.get(0);prevEl.show().addClass("prev show");var transitionName=css3TransNames.transition,transformName=css3TransNames.transform;info.style[transitionName]="all 0s",prev.style[transitionName]="all 0s",info.style[transformName]="translateX("+offset.X+"px)",prev.style[transformName]="translateX("+(offset.X-sWidth+10)+"px)"}this.offset=offset}},end:function(event){if(event.touches){var _this=this;this.isMoving=!1;var offset=this.offset,boundary=50,absOffset=Math.abs(offset.X),absReverseOffset=Math.abs(offset.Y),info=_this.el,prevEl=_this.options.prevEl,prev=prevEl.get(0),transitionName=css3TransNames.transition,transformName=css3TransNames.transform;this.supportAnimations!==!1&&offset.X>=boundary&&absOffset>absReverseOffset?(info.style[transitionName]="all 0.2s",prev.style[transitionName]="all 0.2s",info.style[transformName]="translateX(100%)",prev.style[transformName]="translateX(0)",setTimeout(function(){_this.$el.removeClass("current"),prevEl.show().removeClass("hide prev show"),info.style[transitionName]="",info.style[transformName]="",prev.style[transitionName]="",prev.style[transformName]="",$appRouter.navigate("",{trigger:!1,replace:!0}),$("video").trigger("pause"),_this.$el.html("")},200)):(prevEl.removeClass("prev show").hide(),info.style[transitionName]="",info.style[transformName]="",prev.style[transitionName]="",prev.style[transformName]=""),this.offset.X=this.offset.Y=0;var infoContent=info;infoContent.removeEventListener("touchmove",this,!1),infoContent.removeEventListener("touchend",this,!1)}},backTo:function(evt){evt.stopPropagation(),evt.preventDefault();var _this=this,info=(_this.options.current,$(".J_info")||_this.$el),prev=$(".J_index")||_this.options.prevEl;$appRouter.navigate("",{trigger:!1,replace:!0}),info.addClass("show out"),prev.show().addClass("old_page in"),setTimeout(function(){info.html(""),info.removeClass("current show out"),prev.removeClass("old_page in").show()},600)}});return BookInfo}),define("index",["config","juicer","template","ajax","movies","books","onlines"],function($config,juicer,tpl,Ajax,Movies,Books,Onlines){var Index=Backbone.View.extend({el:$(".J_index"),events:{"click .J_nav_books":"getBooks","click .J_nav_movies":"getMovies","click .J_nav_onlines":"getOnlines"},options:{booksView:null,moviesView:null,onlinesView:null,current:1,prev:1},initialize:function(options){_.extend(this.options,options),this.options.moviesView=new Movies},getBooks:function(evt){evt.stopPropagation(),evt.preventDefault();var _this=this;this.options.booksView||(this.options.booksView=new Books);var booksView=_this.options.booksView;this.switchView(2);var callback=function(){$tipbox.close()};booksView.getBooks(0,callback)},getMovies:function(evt){evt.stopPropagation(),evt.preventDefault(),this.switchView(1);var _this=this,moviesView=_this.options.moviesView,callback=function(){$tipbox.close()};moviesView&&moviesView.getMovies(0,callback)},getOnlines:function(evt){evt.stopPropagation(),evt.preventDefault();var _this=this;this.switchView(3),this.options.onlinesView||(this.options.onlinesView=new Onlines);_this.options.onlinesView},switchView:function(next){{var options=this.options,current=options.current,index=$(".J_index"),indexList=$(".J_index_list"),moviesArea=$(".J_movies_area"),booksArea=$(".J_books_area"),onlinesArea=$(".J_onlines_area"),movies=$(".J_movies"),books=$(".J_books");$(".J_onlines")}if(next&&current!==next){switch(index.find(".current").removeClass("current"),next){case 1:$(".J_nav_movies").addClass("current"),2===current?booksArea.addClass("next"):onlinesArea.addClass("next"),moviesArea.addClass("in"),setTimeout(function(){2===current?booksArea.removeClass("now"):(onlinesArea.removeClass("now"),booksArea.addClass("next")),moviesArea.removeClass("prev in").addClass("now")},100);break;case 2:$(".J_nav_books").addClass("current"),1===current?moviesArea.addClass("prev"):onlinesArea.addClass("next"),booksArea.addClass("in"),setTimeout(function(){1===current?(moviesArea.removeClass("now").addClass("prev"),movies.html("")):onlinesArea.removeClass("now"),booksArea.removeClass("next prev in").addClass("now"),indexList.position().top=0},100);break;case 3:$(".J_nav_onlines").addClass("current"),1===current?moviesArea.addClass("prev"):booksArea.addClass("prev"),onlinesArea.addClass("in"),setTimeout(function(){1===current?(moviesArea.removeClass("now"),booksArea.removeClass("next").addClass("prev"),movies.html("")):(booksArea.removeClass("now").addClass("prev"),books.html("")),onlinesArea.removeClass("next in").addClass("now")},100)}options.prev=options.current,options.current=next,3!==next&&$tipbox&&$tipbox.show({type:"load",str:"努力加载中.."})}}});return new Index});